name: Reusable - Git check

on:
  workflow_call:
    inputs:
      debug:
        description: "Enable debug mode (extra logging, verbose output)"
        required: false
        type: boolean
        default: false
      is-pull-request:
        description: "Identify if build part of a PR"
        required: false
        type: boolean
        default: false
    outputs:
      app_changed:
        description: "Whether application files changed (in src or test folder)"
        value: ${{ jobs.git-check.outputs.app_changed }}
      version_major_minor:
        description: "Version \"Major.Minor\" read from Directory.Build.props file"
        value: ${{ jobs.git-check.outputs.version_major_minor }}

jobs:
  git-check:
    name: Check
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.git-diff.outputs.app_changed }}
      version_major_minor: ${{ steps.extract-version.outputs.version_major_minor }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Debug git context
        if: ${{ inputs.debug }}
        run: |
          echo "Event name (from caller info): ${{ inputs.is-pull-request && 'pull_request' || 'push/other' }}"
          echo "github.sha      = ${{ github.sha }}"
          echo "github.ref_name = ${{ github.ref_name }}"
          echo "base ref        = ${{ github.base_ref }}"
          echo "head ref        = ${{ github.head_ref }}"
          echo "pr base sha     = ${{ github.event.pull_request.base.sha }}"
          echo "pr head sha     = ${{ github.event.pull_request.head.sha }}"
          git log --oneline -n 5 --decorate --graph || true
          echo "---"
      - name: Determine BEFORE commit for diff
        id: set-before
        run: |
          if ${{ inputs.is-pull-request }}; then
            BEFORE="${{ github.event.pull_request.base.sha }}"
          else
            BEFORE="${{ github.event.before }}"
            BEFORE="${BEFORE:-$(git rev-parse HEAD~1 2>/dev/null || echo '')}"
          fi

          if [[ -z "$BEFORE" ]]; then
            echo "No usable before commit → assuming changed"
            echo "before=invalid" >> $GITHUB_OUTPUT
            echo "app_changed=true" >> $GITHUB_OUTPUT
          else
            echo "before=$BEFORE" >> $GITHUB_OUTPUT
          fi
      - name: Check git diff
        id: git-diff
        run: |
          BEFORE="${{ steps.set-before.outputs.before }}"

          if [[ "$BEFORE" == "invalid" ]]; then
            echo "app_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Comparing:"
          echo "  from : $BEFORE"
          echo "  to   : ${{ github.sha }}"

          if git diff --quiet "$BEFORE" ${{ github.sha }} -- src test ; then
            echo "No relevant changes"
            echo "app_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in src/test"
            git diff --name-status "$BEFORE" ${{ github.sha }} -- src test
            echo "app_changed=true" >> $GITHUB_OUTPUT
          fi
      - name: Extract version from Directory.Build.props
        id: extract-version
        run: |
          VERSION_PREFIX=$(grep -oP '(?<=<VersionPrefix>).*?(?=</VersionPrefix>)' Directory.Build.props | tr -d ' \t\n\r')

          if [ -z "$VERSION_PREFIX" ]; then
            echo "Error: Could not find VersionPrefix in Directory.Build.props"
            exit 1
          fi

          MAJOR_MINOR=$(echo "$VERSION_PREFIX" | cut -d'.' -f1-2)
          echo "Major.Minor: $MAJOR_MINOR"
          echo "version_major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
