name: Reusable - Git check

on:
  workflow_call:
    inputs:
      debug:
        description: "Enable debug mode (extra logging, verbose output)"
        required: false
        type: boolean
        default: false
    outputs:
      app_changed:
        description: "Whether application files changed (in src or test folder)"
        value: ${{ jobs.git-check.outputs.app_changed }}
      version_major_minor:
        description: "Version \"Major.Minor\" read from Directory.Build.props file"
        value: ${{ jobs.git-check.outputs.version_major_minor }}

jobs:
  git-check:
    name: Check
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.git-diff.outputs.app_changed }}
      version_major_minor: ${{ steps.extract-version.outputs.version_major_minor }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Debug git context
        if: ${{ inputs.debug }}
        run: |
          echo "Event before SHA: ${{ github.event.before }}"
          echo "Current SHA (github.sha): ${{ github.sha }}"
          echo "Ref/branch: ${{ github.ref_name }}"
          git log --oneline -n 2 || echo "git log failed"
          echo ""
          echo "Quick diff summary:"
          git diff --name-status ${{ github.event.before }} ${{ github.sha }} -- src test 2>/dev/null \
            || echo "No changes in src test or diff failed"
      - name: Check git diff
        id: git-diff
        run: |
          BEFORE="${{ github.event.before }}"
          BEFORE="${BEFORE:-$(git rev-parse HEAD~1 2>/dev/null)}"
          echo "BEFORE=$BEFORE"

          if [[ -z "$BEFORE" ]]; then
            echo "app_changed=true" >> $GITHUB_OUTPUT
          elif git diff --quiet "$BEFORE" ${{ github.sha }} -- src test ; then
            echo "app_changed=false" >> $GITHUB_OUTPUT
            echo "app_changed=false"
          else
            echo "app_changed=true" >> $GITHUB_OUTPUT
          fi
      - name: Extract version from Directory.Build.props
        id: extract-version
        run: |
          VERSION_PREFIX=$(grep -oP '(?<=<VersionPrefix>).*?(?=</VersionPrefix>)' Directory.Build.props | tr -d ' \t\n\r')

          if [ -z "$VERSION_PREFIX" ]; then
            echo "Error: Could not find VersionPrefix in Directory.Build.props"
            exit 1
          fi

          MAJOR_MINOR=$(echo "$VERSION_PREFIX" | cut -d'.' -f1-2)

          echo "Major.Minor: $MAJOR_MINOR"

          echo "version_major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
