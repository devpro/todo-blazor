@page "/todo"

@using Devpro.TodoList.BlazorApp.Identity
@using Devpro.TodoList.BlazorApp.Models
@using Devpro.TodoList.BlazorApp.Repositories
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject TodoItemRepository TodoItemRepository

@rendermode InteractiveServer

@attribute [Authorize]

<PageTitle>Todo</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Todo <span class="badge bg-primary">@todos.Count(t => !t.IsDone)</span></h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3 mb-0" role="alert">
            @errorMessage
        </div>
    }

    @if (isReady)
    {
        @if (isLoading)
        {
            <div class="alert alert-info text-center my-4" data-testid="loading-message">
                Loading your tasks...
            </div>
        }
        else
        {
            <div class="input-group mb-4">
                <input type="text" class="form-control" id="new-title" data-testid="new-todo-input" disabled="@isLoading" placeholder="What needs to be done?"
                       @bind="newTitle" @bind:event="oninput"
                       @onkeyup="@(e =>
                       {
                           if (e.Key == "Enter" || e.Key == "NumpadEnter")
                           {
                               _ = AddTodoAsync();
                           }
                       })" />

                <button class="btn btn-primary" id="add-btn" data-testid="add-button" @onclick="AddTodoAsync"
                        disabled="@string.IsNullOrWhiteSpace(newTitle?.Trim())">
                    Add
                </button>
            </div>

            @if (!todos.Any())
            {
                <div class="alert alert-info text-center">No tasks yet — add one above!</div>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var todo in todos)
                    {
                        <li class="list-group-item d-flex align-items-center" data-todo-id="@todo.Id" data-testid="todo-row"
                            @onkeyup="@(e => HandleKeyUpAsync(e, todo))">

                            <input type="checkbox" class="form-check-input me-3 fs-5" data-testid="done-checkbox"
                                   id="chk-@todo.Id" @bind="todo.IsDone"
                                   @bind:after="@(() => _ = ToggleDoneAsync(todo))" />

                            @if (editingId == todo.Id)
                            {
                                <input type="text"
                                       class="form-control me-2 flex-grow-1"
                                       value="@editTitle"
                                       @oninput="@(e => editTitle = e.Value?.ToString() ?? "")"
                                       autofocus />

                                <button class="btn btn-sm btn-success me-1" data-testid="save-button"
                                        @onclick="() => _ = SaveEditAsync(todo)">
                                    Save
                                </button>

                                <button class="btn btn-sm btn-secondary" data-testid="cancel-button"
                                        @onclick="CancelEdit">
                                    Cancel
                                </button>
                            }
                            else
                            {
                                <div class="flex-grow-1 me-3 d-flex align-items-center" style="min-height: 38px;">
                                    <span class="@(todo.IsDone ? "text-muted text-decoration-line-through" : "")">
                                        @todo.Title
                                    </span>
                                </div>

                                <button class="btn btn-sm btn-outline-primary me-1" data-testid="edit-button"
                                        @onclick="() => StartEdit(todo)">
                                    Edit
                                </button>

                                <button class="btn btn-sm btn-outline-danger" id="del-@todo.Id" data-testid="delete-button"
                                        @onclick="() => ShowDelete(todo)">
                                    Delete
                                </button>
                            }
                        </li>
                    }
                </ul>
            }
        }
    }
</div>

@if (todoToDelete != null)
{
    <div class="modal fade show d-block" data-testid="delete-confirmation-modal" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Confirm Delete</h5>
                    <button class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    Delete "<strong>@todoToDelete.Title</strong>"?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-testid="cancel-delete" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" data-testid="confirm-delete" @onclick="ConfirmDeleteAsync">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; } = default!;

    private bool isReady = false;
    private bool isLoading = true;
    private ApplicationUser? user;
    private List<TodoItem> todos = [];
    private string? newTitle;
    private string? editingId;
    private string? editTitle;
    private TodoItem? todoToDelete;
    private string? errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(1);
            isReady = true;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            NavigationManager.NavigateTo("/identity/account/login?returnUrl=" + Uri.EscapeDataString(NavigationManager.Uri), forceLoad: true);
            return;
        }

        await LoadTodoAsync(userId);

        isLoading = false;
    }

    private async Task HandleKeyUpAsync(KeyboardEventArgs e, TodoItem todo)
    {
        if (e.Key == "Enter" || e.Key == "NumpadEnter")
        {
            await SaveEditAsync(todo);
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    private async Task AddTodoAsync()
    {
        var title = newTitle?.Trim();
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(title) || string.IsNullOrEmpty(userId))
        {
            return;
        }

        var todoItem = new TodoItem { Title = title, IsDone = false, UserId = userId };
        await TodoItemRepository.CreateAsync(todoItem);
        await LoadTodoAsync(userId);
        newTitle = null;
        StateHasChanged();
    }

    private async Task ToggleDoneAsync(TodoItem todoItem)
    {
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(userId) || todoItem.UserId != userId)
        {
            return;
        }

        await TodoItemRepository.UpdateAsync(todoItem);
    }

    private void ShowDelete(TodoItem todoItem)
    {
        todoToDelete = todoItem;
    }

    private void CancelDelete()
    {
        todoToDelete = null;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (todoToDelete == null)
        {
            return;
        }

        var todo = todoToDelete;
        todoToDelete = null;

        try
        {
            await TodoItemRepository.DeleteAsync(todo.Id);
            todos.Remove(todo);
            if (editingId == todo.Id)
            {
                editingId = null;
            }
        }
        catch
        {
            errorMessage = "Could not delete the task.";
        }
    }

    private void StartEdit(TodoItem todo)
    {
        editingId = todo.Id;
        editTitle = todo.Title;
    }

    private void CancelEdit()
    {
        editingId = null;
        editTitle = null;
    }

    private async Task SaveEditAsync(TodoItem todo)
    {
        var newTitle = editTitle?.Trim();
        if (editingId != todo.Id
            || string.IsNullOrEmpty(newTitle)
            || newTitle == todo.Title)
        {
            editingId = null;
            editTitle = null;
            return;
        }

        var originalTitle = todo.Title;
        todo.Title = newTitle;
        try
        {
            await TodoItemRepository.UpdateAsync(todo);
        }
        catch
        {
            todo.Title = originalTitle;
            errorMessage = "Could not save the title.";
        }

        editingId = null;
        editTitle = null;
    }

    private async Task<string?> GetCurrentUserIdAsync()
    {
        var authState = await AuthenticationState;
        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            return null;
        }

        user = await UserManager.GetUserAsync(authState.User);
        if (user is null)
        {
            errorMessage = "User not found.";
            return string.Empty;
        }

        return user.Id.ToString();
    }

    private async Task LoadTodoAsync(string userId)
    {
        todos = await TodoItemRepository.FindAsync(userId);
    }
}
