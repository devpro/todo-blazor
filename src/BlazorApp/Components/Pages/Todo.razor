@page "/todo"

@using Devpro.TodoList.BlazorApp.Identity
@using Devpro.TodoList.BlazorApp.Models
@using Devpro.TodoList.BlazorApp.Repositories
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject TodoItemRepository TodoItemRepository

@rendermode InteractiveServer

@attribute [Authorize]

<PageTitle>Todo</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Todo <span class="badge bg-primary">@_todos.Count(t => !t.IsDone)</span></h1>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mt-3 mb-0" role="alert">
            @_errorMessage
        </div>
    }

    @if (_isReady)
    {
        @if (_isLoading)
        {
            <div class="alert alert-info text-center my-4" data-testid="loading-message">
                Loading your tasks...
            </div>
        }
        else
        {
            <div class="input-group mb-4">
                <input type="text" class="form-control" data-testid="new-input" disabled="@_isLoading"
                       placeholder="What needs to be done?"
                       @bind="_newTitle" @bind:event="oninput"
                       @onkeyup="@(e =>
                       {
                           if (e.Key is "Enter" or "NumpadEnter")
                           {
                               _ = AddTodoAsync();
                           }
                       })" />

                <button class="btn btn-primary" data-testid="add-button" @onclick="AddTodoAsync"
                        disabled="@string.IsNullOrWhiteSpace(_newTitle?.Trim())">
                    Add
                </button>
            </div>

            @if (!_todos.Any())
            {
                <div class="alert alert-info text-center">No tasks yet — add one above!</div>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var todo in _todos)
                    {
                        <li class="list-group-item d-flex align-items-center" data-testid="todo-@todo.Id"
                            @onkeyup="@(e => HandleKeyUpAsync(e, todo))">

                            <input type="checkbox" class="form-check-input me-3 fs-5"
                                   id="chk-@todo.Id" @bind="todo.IsDone"
                                   @bind:after="@(() => _ = ToggleDoneAsync(todo))" />

                            @if (_editingId == todo.Id)
                            {
                                <input type="text"
                                       class="form-control me-2 flex-grow-1"
                                       value="@_editTitle"
                                       @oninput="@(e => _editTitle = e.Value?.ToString() ?? "")"
                                       autofocus />

                                <button class="btn btn-sm btn-success me-1"
                                        @onclick="() => _ = SaveEditAsync(todo)">
                                    Save
                                </button>

                                <button class="btn btn-sm btn-secondary"
                                        @onclick="CancelEdit">
                                    Cancel
                                </button>
                            }
                            else
                            {
                                <div class="flex-grow-1 me-3 d-flex align-items-center" style="min-height: 38px;">
                                    <span class="@(todo.IsDone ? "text-muted text-decoration-line-through" : "")">
                                        @todo.Title
                                    </span>
                                </div>

                                <button class="btn btn-sm btn-outline-primary me-1"
                                        @onclick="() => StartEdit(todo)">
                                    Edit
                                </button>

                                <button class="btn btn-sm btn-outline-danger" id="del-@todo.Id"
                                        @onclick="() => ShowDelete(todo)">
                                    Delete
                                </button>
                            }
                        </li>
                    }
                </ul>
            }
        }
    }
</div>

@if (_todoToDelete != null)
{
    <div class="modal fade show d-block" data-testid="delete-confirmation-modal" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Confirm Delete</h5>
                    <button class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    Delete "<strong>@_todoToDelete.Title</strong>"?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-testid="cancel-delete" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" data-testid="confirm-delete" @onclick="ConfirmDeleteAsync">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; } = default!;

    private bool _isReady;
    private bool _isLoading = true;
    private ApplicationUser? _user;
    private List<TodoItem> _todos = [];
    private string? _newTitle;
    private string? _editingId;
    private string? _editTitle;
    private TodoItem? _todoToDelete;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(1);
            _isReady = true;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            NavigationManager.NavigateTo("/identity/account/login?returnUrl=" + Uri.EscapeDataString(NavigationManager.Uri), forceLoad: true);
            return;
        }

        await LoadTodoAsync(userId);

        _isLoading = false;
    }

    private async Task HandleKeyUpAsync(KeyboardEventArgs e, TodoItem todo)
    {
        switch (e.Key)
        {
            case "Enter" or "NumpadEnter":
                await SaveEditAsync(todo);
                break;
            case "Escape":
                CancelEdit();
                break;
        }
    }

    private async Task AddTodoAsync()
    {
        var title = _newTitle?.Trim();
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(title) || string.IsNullOrEmpty(userId))
        {
            return;
        }

        var todoItem = new TodoItem { Title = title, IsDone = false, UserId = userId };
        await TodoItemRepository.CreateAsync(todoItem);
        await LoadTodoAsync(userId);
        _newTitle = null;
        StateHasChanged();
    }

    private async Task ToggleDoneAsync(TodoItem todoItem)
    {
        var userId = await GetCurrentUserIdAsync();
        if (string.IsNullOrEmpty(userId) || todoItem.UserId != userId)
        {
            return;
        }

        await TodoItemRepository.UpdateAsync(todoItem);
    }

    private void ShowDelete(TodoItem todoItem)
    {
        _todoToDelete = todoItem;
    }

    private void CancelDelete()
    {
        _todoToDelete = null;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (_todoToDelete == null)
        {
            return;
        }

        var todo = _todoToDelete;
        _todoToDelete = null;

        try
        {
            await TodoItemRepository.DeleteAsync(todo.Id);
            _todos.Remove(todo);
            if (_editingId == todo.Id)
            {
                _editingId = null;
            }
        }
        catch
        {
            _errorMessage = "Could not delete the task.";
        }
    }

    private void StartEdit(TodoItem todo)
    {
        _editingId = todo.Id;
        _editTitle = todo.Title;
    }

    private void CancelEdit()
    {
        _editingId = null;
        _editTitle = null;
    }

    private async Task SaveEditAsync(TodoItem todo)
    {
        var newVal = _editTitle?.Trim();
        if (_editingId != todo.Id
            || string.IsNullOrEmpty(newVal)
            || newVal == todo.Title)
        {
            _editingId = null;
            _editTitle = null;
            return;
        }

        var originalTitle = todo.Title;
        todo.Title = newVal;
        try
        {
            await TodoItemRepository.UpdateAsync(todo);
        }
        catch
        {
            todo.Title = originalTitle;
            _errorMessage = "Could not save the title.";
        }

        _editingId = null;
        _editTitle = null;
    }

    private async Task<string?> GetCurrentUserIdAsync()
    {
        var authState = await AuthenticationState;
        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            return null;
        }

        _user = await UserManager.GetUserAsync(authState.User);
        if (_user is not null)
        {
            return _user.Id.ToString();
        }

        _errorMessage = "User not found.";
        return string.Empty;
    }

    private async Task LoadTodoAsync(string userId)
    {
        _todos = await TodoItemRepository.FindAsync(userId);
    }
}
